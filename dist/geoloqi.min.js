/*! Geoloqi JS - 2.0.0alpha1 - 2012-11-20
*   https://github.com/geoloqi/geoloqi-js-2
*   Copyright (c) 2012 Environmental Systems Research Institute, Inc.
*   Licensed MIT */
(function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd&&define(t),window&&navigator&&(e.geoloqi=t())})(this,function(){var e="2.0.0-alpha1",t="http://cors-server.herokuapp.com/",n={},r={},i={},s={},o=function(e){if(!e.app_id)throw"geoloqi: You must pass an app_id to geoloqi.init()";if(e.app_secret&&e.device_secret)throw"geoloqi: You cannot pass `app_secret` AND `device_secret` to geoloqi.init()";r.app_id=e.app_id,e.app_secret&&(r.app_secret=e.app_secret),e.device_secret&&(r.device_secret=e.device_secret),window.jQuery&&window.dojo?s.integration=e.integration||window.jQuery:s.integration=window.jQuery||window.dojo,p.fire("init")};n.init=o,n.config=s;var u=function(){r=n.auth={}};n.destory=u;var a=function(){return r.app_id&&(r.app_secret||r.device_secret)};n.authenticated=a;var f=function(e,n,i,o,u,a){var f=[].splice.call(arguments,0);typeof f[1]=="object"&&(n=f[1].method,i=f[1].data,o=f[1].callback,u=f[1].context),typeof f[2]=="function"&&(o=f[2],u=f[3]),typeof f[2]=="undefined"&&typeof f[3]=="undefined"&&typeof f[1]!="object"&&(i={});if(!e)throw"geoloqi: requires a http_method parameter";if(!n)throw"geoloqi: requires a method parameter";p.fire("request:started",e,n,i);var l,c=u?u:window,h=s.integration?new s.integration.Deferred:null,v=function(){var e=JSON.parse(l.responseText),t=e.error?null:e,n=e.error?e.error:null;a?(o&&o.call(c,l),h&&!n?h.resolve(l):h&&n&&h.reject(l)):(o&&o.call(c,t,n),h&&!n?h.resolve(t):h&&n&&h.reject(n)),n?p.fire("request:error",n):p.fire("request:success",t),p.fire("request:completed",t,n)},m=function(){var e={type:"http_error",message:"your request could not be completed"};o&&o.call(c,null,e),h&&h.reject(e),p.fire("request:error",e),p.fire("request:completed",e)},g=function(){l instanceof XMLHttpRequest&&l.readyState===4&&l.status<400?v():l instanceof XMLHttpRequest&&l.readyState===4&&l.status>=400?m():l instanceof XMLHttpRequest||l instanceof XDomainRequest&&v()};window.XDomainRequest?(l=new XDomainRequest,l.onload=g,l.onerror=m,l.ontimeout=m):window.XMLHttpRequest&&(l=new XMLHttpRequest,l.onreadystatechange=g);var y=i?d.merge(r,i):r,b=d.toQueryString(y);switch(e){case"GET":l.open("GET",t+n+"?"+b),l.send(null);break;case"POST":l.open("POST",t+n),l instanceof XMLHttpRequest&&l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.send(b)}return h},l=function(e,t,n,r,i){return f(e,t,n,r,i,!0)};n.request=l;var c=function(e,t,n,r){return f("GET",e,t,n,r,!1)};n.get=c;var h=function(e,t,n,r){return f("POST",e,t,n,r,!1)};n.post=h;var p={addListener:function(e,t){typeof i[e]=="undefined"&&(i[e]=[]),i[e].push(t)},fire:function(e){var t=[].splice.call(arguments,1);if(i[e]instanceof Array){var r=i[e];for(var s=0,o=r.length;s<o;s++)r[s].apply(n,t)}},removeListener:function(e,t){if(i[e]instanceof Array){var n=i[e];for(var r=0,s=n.length;r<s;r++)if(n[r]===t){n.splice(r,1);break}}}};n.fire=p.fire,n.on=p.addListener,n.addListener=p.addListener,n.off=p.addListener,n.removeListener=p.removeListener;var d={merge:function(e,t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n},s4:function(){return Math.floor(Math.random()*65536).toString(16)},guid:function(){return d.S4()+d.S4()+"-"+d.S4()+"-"+d.S4()+"-"+d.S4()+"-"+d.S4()+d.S4()+d.S4()},log:function(){if(window.console&&window.console.log){var e=[].splice.call(arguments,0);console.log("geoloqi:",e)}},toQueryString:function(e,t){if(typeof e!="object")return"";var n="";for(var r in e)if(e.hasOwnProperty(r)){var i=t?t+"."+r:r;if(e[r]instanceof Array)for(var s=0;s<e[r].length;s++)typeof e[r][s]=="object"?n+="&"+d.toQueryString(e[r][s],i):n+="&"+encodeURIComponent(i)+"="+encodeURIComponent(e[r][s]);else e[r]instanceof Date?n+="&"+encodeURIComponent(i)+"="+e[r].getTime():e[r]instanceof Object?e.toString&&e.toString!==Object.prototype.toString?n+="&"+encodeURIComponent(i)+"="+encodeURIComponent(e[r].toString()):n+="&"+d.toQueryString(e[r],i):n+="&"+encodeURIComponent(i)+"="+encodeURIComponent(e[r])}return n.replace(/^&/,"")}};return n});
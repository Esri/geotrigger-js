/*! Geoloqi JS - 2.0.0alpha1 - 2012-11-16
*   https://github.com/geoloqi/geoloqi-js-2
*   Copyright (c) 2012 Environmental Systems Research Institute, Inc.
*   Licensed MIT */
var geoloqi=function(){var e="0.0.1",t="",n="http://cors-server.herokuapp.com/",r={},i={},s={},o={},u=function(e){if(!e.app_id)throw"geoloqi: You must pass an app_id to geoloqi.init()";if(e.app_secret&&e.device_secret)throw"geoloqi: You cannot pass `app_secret` AND `device_secret` to geoloqi.init()";i.app_id=e.app_id,e.app_secret&&(i.app_secret=e.app_secret),e.device_secret&&(i.device_secret=e.device_secret),window.jQuery&&window.dojo?o.integration=e.integration||window.jQuery:o.integration=window.jQuery||window.dojo,d.fire("init")};r.init=u,r.config=o;var a=function(){i=r.auth={}};r.destory=a;var f=function(){return i.app_id&&(i.app_secret||i.device_secret)};r.authenticated=f;var l=function(e,t,r,s,u,a){var f=[].splice.call(arguments,0);typeof f[1]=="object"&&(t=f[1].method,r=f[1].data,s=f[1].callback,u=f[1].context),typeof f[2]=="function"&&(s=f[2],u=f[3]),typeof f[2]=="undefined"&&typeof f[3]=="undefined"&&typeof f[1]!="object"&&(r={});if(!e)throw"geoloqi: requires a http_method parameter";if(!t)throw"geoloqi: requires a method parameter";d.fire("request:started",e,t,r);var l,c=u?u:window,h=o.integration?new o.integration.Deferred:null,p=function(){var e=JSON.parse(l.responseText),t=e.error?null:e,n=e.error?e.error:null;a?(s&&s.call(c,l),h&&!n?h.resolve(l):h&&n&&h.reject(l)):(s&&s.call(c,t,n),h&&!n?h.resolve(t):h&&n&&h.reject(n)),n?d.fire("request:error",n):d.fire("request:success",t),d.fire("request:completed",t,n)},m=function(){var e={type:"http_error",message:"your request could not be completed"};s&&s.call(c,null,e),h&&h.reject(e),d.fire("request:error",e),d.fire("request:completed",e)},g=function(){l instanceof XMLHttpRequest&&l.readyState===4&&l.status<400?p():l instanceof XMLHttpRequest&&l.readyState===4&&l.status>=400?m():l instanceof XMLHttpRequest||l instanceof XDomainRequest&&p()};window.XDomainRequest?(l=new XDomainRequest,l.onload=g,l.onerror=m,l.ontimeout=m):window.XMLHttpRequest&&(l=new XMLHttpRequest,l.onreadystatechange=g);var y=r?v.merge(i,r):i,b=v.toQueryString(y);switch(e){case"GET":l.open("GET",n+t+"?"+b),l.send(null);break;case"POST":l.open("POST",n+t),l instanceof XMLHttpRequest&&l.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),l.send(b)}return h},c=function(e,t,n,r,i){return l(e,t,n,r,i,!0)};r.request=c;var h=function(e,t,n,r){return l("GET",e,t,n,r,!1)};r.get=h;var p=function(e,t,n,r){return l("POST",e,t,n,r,!1)};r.post=p;var d={addListener:function(e,t){typeof s[e]=="undefined"&&(s[e]=[]),s[e].push(t)},fire:function(e){var t=[].splice.call(arguments,1);if(s[e]instanceof Array){var n=s[e];for(var i=0,o=n.length;i<o;i++)n[i].apply(r,t)}},removeListener:function(e,t){if(s[e]instanceof Array){var n=s[e];for(var r=0,i=n.length;r<i;r++)if(n[r]===t){n.splice(r,1);break}}}};r.fire=d.fire,r.on=d.addListener,r.addListener=d.addListener,r.off=d.addListener,r.removeListener=d.removeListener;var v={merge:function(e,t){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n},s4:function(){return Math.floor(Math.random()*65536).toString(16)},guid:function(){return v.S4()+v.S4()+"-"+v.S4()+"-"+v.S4()+"-"+v.S4()+"-"+v.S4()+v.S4()+v.S4()},log:function(){if(window.console&&window.console.log){var e=[].splice.call(arguments,0);console.log("geoloqi:",e)}},toQueryString:function(e,t){if(typeof e!="object")return"";var n="";for(var r in e)if(e.hasOwnProperty(r)){var i=t?t+"."+r:r;if(e[r]instanceof Array)for(var s=0;s<e[r].length;s++)typeof e[r][s]=="object"?n+="&"+v.toQueryString(e[r][s],i):n+="&"+encodeURIComponent(i)+"="+encodeURIComponent(e[r][s]);else e[r]instanceof Date?n+="&"+encodeURIComponent(i)+"="+e[r].getTime():e[r]instanceof Object?e.toString&&e.toString!==Object.prototype.toString?n+="&"+encodeURIComponent(i)+"="+encodeURIComponent(e[r].toString()):n+="&"+v.toQueryString(e[r],i):n+="&"+encodeURIComponent(i)+"="+encodeURIComponent(e[r])}return n.replace(/^&/,"")}};return r}();
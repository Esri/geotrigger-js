/*! geotriggers-js - v0.0.1 - 2013-04-19
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/

(function(e,t){"object"==typeof module&&"object"==typeof module.exports&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest,exports=module.exports=t()),"function"==typeof define&&define.amd&&define(t),"object"==typeof window&&(e.Geotriggers=t())})(this,function(){function e(e){this._requestQueue=[],this._events={};var o={session:{},preferLocalStorage:!0,persistSession:"undefined"!=typeof module&&module.exports?!1:!0,geotriggersUrl:t,tokenUrl:s,registerDeviceUrl:r,debug:!1,automaticRegistation:!0};if(!e.applicationId&&!e.session)throw Error("Geotriggers.Session requires an `applicationId` or a `session` parameter.");i.merge(this,i.merge(o,e)),this.authenticatedAs=this.applicationId&&this.applicationSecret?"application":"device",this.key="_geotriggers_"+this.authenticatedAs+"_"+this.applicationId,this.persistSession&&(this.preferLocalStorage&&a?i.merge(this,h.get(this.key)):c&&i.merge(this,u.get(this.key))),e.session&&i.merge(this,e.session),(this.accessToken&&Date.now()>new Date(this.expiresOn).getTime()||!this.accessToken)&&this.refresh()}var t="http://geotriggersdev.arcgis.com/",s="https://devext.arcgis.com/sharing/oauth2/token",r="https://devext.arcgis.com/sharing/oauth2/registerDevice",o={},n=function n(){this._thens=[]};n.prototype={then:function(e,t){return this._thens.push({resolve:e,reject:t}),this},success:function(e){return this.then(e),this},error:function(e){return this.then(null,e),this},resolve:function(e){this._complete("resolve",e)},reject:function(e){this._complete("reject",e)},_complete:function(e,t){this.then="resolve"===e?function(e){e(t)}:function(e,s){s(t)},this.success=function(e){e(t)},this.error=function(e){e(t)},this.resolve=this.reject=function(){throw Error("Deferred already completed.")};for(var s=0;this._thens.length>s;s++){var r=this._thens[s];r[e]&&r[e](t)}delete this._thens}},o.Deferred=n,e.prototype.get=function(e,t){return t=t||{},t.type="GET",t.method=e,t.returnXHR=!1,this.request(t)},e.prototype.post=function(e,t){return t=t||{},t.type="POST",t.method=e,t.returnXHR=!1,this.request(t)},e.prototype.authenticated=function(){return!!this.accessToken},e.prototype._runQueue=function(){for(var e=0;this._requestQueue.length>e;e++){var t=this._requestQueue[e];this.request(t.options,t.deferred)}},e.prototype.refresh=function(){this.log("refrehsing session"),this.applicationSecret?(this.log("getting new application token"),this.post(this.tokenUrl,{params:{client_id:this.applicationId,client_secret:this.applicationSecret,f:"json",grant_type:"client_credentials"}}).then(i.bind(this,function(e){this.accessToken=e.access_token,this.expiresOn=new Date((new Date).getTime()+1e3*(e.expires_in-300)),this._processAuth()}),i.bind(this,this._authError))):this.refreshToken?(this.log("getting new device token with a refresh token"),this.post(this.tokenUrl,{params:{client_id:this.applicationId,refresh_token:this.refreshToken,f:"json",grant_type:"refresh_token"}}).then(i.bind(this,function(e){this.accessToken=e.access_token,this.refreshToken=e.refresh_token,this.expiresOn=new Date((new Date).getTime()+1e3*(e.expires_in-300)),this._processAuth()}),i.bind(this,this._authError))):this.automaticRegistation&&(this.log("no applicaitonSecret or refreshToken, registering a new device"),this.post(this.registerDeviceUrl,{params:{client_id:this.applicationId,f:"json"}}).then(i.bind(this,function(e){this.deviceId=e.device.deviceId,this.accessToken=e.deviceToken.access_token,this.refreshToken=e.deviceToken.refresh_token,this.expiresOn=new Date((new Date).getTime()+1e3*(e.deviceToken.expires_in-300)),this._processAuth(e)}),i.bind(this,this._authError)))},e.prototype.toJSON=function(){var e={};for(var t in this)this.hasOwnProperty(t)&&this[t]&&!t.match(/^_.+/)&&(e[t]=this[t]);return e},e.prototype.on=function(e,t){this._events[e]===void 0&&(this._events[e]=[]),this._events[e].push(t)},e.prototype.emit=function(e){var t=[].splice.call(arguments,1);if(this._events[e]instanceof Array)for(var s=this._events[e],r=0,o=s.length;o>r;r++)s[r].apply(this,t)},e.prototype.off=function(e,t){if(this._events[e]instanceof Array)for(var s=this._events[e],r=0,o=s.length;o>r;r++)if(s[r]===t){s.splice(r,1);break}},e.prototype._processAuth=function(e){this.persistSession&&this.persist(),this.log("session refreshed running queue"),this._runQueue(),this.emit("authentication:success",e),this.emit("authenticated",e)},e.prototype._authError=function(e){this.log("error getting token or registering device from ArcGIS, "+e.error_description),this.emit("authentication:failure",e)},e.prototype.log=function(){var e=Array.prototype.slice.apply(arguments);e.unshift(this.key),this.debug&&i.log.apply(this,e)},e.prototype.request=function(e,t){var s,r=this,n={params:{},callback:null,returnXHR:!0},a=t||new o.Deferred,c=i.merge(n,e),h=!c.method.match(/^https?:\/\//),u=h?this.geotriggersUrl+c.method:c.method;if(!this.authenticated()&&h)return this.log("not authenticated for request to "+u+" as a "+this.authenticatedAs+" refreshing session and queuing request"),this._requestQueue.push({deferred:a,options:e}),a;this.log("making request to "+u+" as a "+this.authenticatedAs),c.callback&&a.then(function(e){c.callback(null,e)},function(e){c.callback(e,null)});var p=function(){r.log("successful http request to "+u+" as a "+r.authenticatedAs);var t=JSON.parse(s.responseText),o=t.error?null:t,n=t.error?t.error:null;if(n&&"invalidHeader"===n.type&&n.headers.Authorization)e.addCallbacksToDeferred=!1,r._requestQueue.push({options:e,deferred:a}),r.refresh();else if(c.returnXHR&&!n)r.log("running success callback for request to "+u+" with ",s),a.resolve(s);else if(c.returnXHR&&n)r.log("running error callback for request to "+u+" with ",s),a.reject(s);else if(n)if(n)r.log("running error callback for request to "+u+" with ",o),a.reject(n);else{var i={type:"unexpected_response",message:"the api returned a non json or unexpected data"};r.log("running error callback for request to "+u+" with ",i),a.reject(i)}else r.log("running success callback for request to "+u+" with ",o),a.resolve(o)},l=function(){var e=JSON.parse(s.responseText);r.log("request to "+u+" as a "+r.authenticatedAs+" failed with ",e);var t={type:"http_error",message:e};a.reject(t)},f=function(){s instanceof XMLHttpRequest&&4===s.readyState&&400>s.status?p():s instanceof XMLHttpRequest&&4===s.readyState&&s.status>=400?l():s instanceof XMLHttpRequest||s instanceof XDomainRequest&&p()};if("undefined"!=typeof XDomainRequest)s=new XDomainRequest,s.onload=f,s.onerror=l,s.ontimeout=l;else{if("undefined"==typeof XMLHttpRequest)throw Error("This browser does not support XMLHttpRequest or XDomainRequest");s=new XMLHttpRequest,s.onreadystatechange=f}var d=i.serialize(c.params);switch(c.type){case"GET":s.open("GET",u+"?"+d),h&&s.setRequestHeader("Authorization","Bearer "+this.accessToken),s.send(null),this.log("sent GET request to "+u+" as a "+this.authenticatedAs+" with",c.params);break;case"POST":s.open("POST",u),s instanceof XMLHttpRequest&&s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h&&s.setRequestHeader("Authorization","Bearer "+this.accessToken),s.send(d),this.log("sent POST request to "+u+" as a "+this.authenticatedAs+" with",c.params)}return a},e.prototype.persist=function(){var e={};this.applicationSecret&&(e.applicationSecret=this.applicationSecret),this.accessToken&&(e.accessToken=this.accessToken),this.refreshToken&&(e.refreshToken=this.refreshToken),this.deviceId&&(e.deviceId=this.deviceId),this.preferLocalStorage&&a?(this.log("persisting session to localStorage ",e),h.set(this.key,e)):c&&(this.log("persisting session to cookie ",e),u.set(this.key,e))},e.prototype.destroy=function(){this.log("destorying persisted session"),this.preferLocalStorage&&a?h.erase(this.key):c&&u.erase(this.key)},o.Session=e;var i={bind:function(e,t){var s,r;if("function"!=typeof t)throw new TypeError;return"function"==typeof Function.prototype.bind?t.bind(e):(r=Array.prototype.slice.call(arguments,2),s=function(){if(!(this instanceof s))return t.apply(e,r.concat(Array.prototype.slice.call(arguments)));var o;o.prototype=t.prototype;var n=new o,i=t.apply(n,r.concat(Array.prototype.slice.call(arguments)));return Object(i)===i?i:n})},merge:function(e,t){for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);return e},log:function(){var e=Array.prototype.slice.apply(arguments);void 0!==typeof console&&console.log&&console.log.apply(console,e)},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},serialize:function(e,t){var s=encodeURIComponent,r=[];for(var o in e){var n,a=t?t+"["+o+"]":o,c=e[o];n="properties"===a||"condition[geo][geojson]"===a||"locations"===a||"data"===a?s(a)+"="+s(JSON.stringify(c)):i.isObject(c)?i.serialize(c,a):s(a)+"="+s(c),r.push(n)}return r.join("&")},toQueryString:function(e,t){if("object"!=typeof e)return"";var s="";for(var r in e)if(e.hasOwnProperty(r)){var o=t?t+"."+r:r;if(e[r]instanceof Array)for(var n=0;e[r].length>n;n++)s+="object"==typeof e[r][n]?"&"+i.toQueryString(e[r][n],o):"&"+encodeURIComponent(o)+"="+encodeURIComponent(e[r][n]);else s+=e[r]instanceof Date?"&"+encodeURIComponent(o)+"="+e[r].getTime():e[r]instanceof Object?e.toString&&e.toString!==Object.prototype.toString?"&"+encodeURIComponent(o)+"="+encodeURIComponent(""+e[r]):"&"+i.toQueryString(e[r],o):"&"+encodeURIComponent(o)+"="+encodeURIComponent(e[r])}return s.replace(/^&/,"")}},a="object"==typeof window&&"object"==typeof window.localStorage?!0:!1,c="object"==typeof document&&"string"==typeof document.cookie?!0:!1,h={set:function(e,t){window.localStorage.setItem(e,JSON.stringify(t))},get:function(e){return JSON.parse(window.localStorage.getItem(e))},erase:function(e){window.localStorage.removeItem(e)}},u={get:function(e){var t=document.cookie.match(RegExp(e+"=[a-zA-Z0-9.()=|%/_]+($|;)","g"));return t&&t[0]?JSON.parse(t[0].substring(e.length+1,t[0].length).replace(";",""))||null:null},set:function(e,t,s){var r=[e+"="+JSON.stringify(t),"path=/","domain="+window.location.host],o=new Date;return o.setFullYear(o.getFullYear()+1),r.push(o.toGMTString()),s&&r.push("secure"),document.cookie=r.join("; ")},erase:function(e){document.cookie=e+"; "+new Date(0).toUTCString()}};return o});